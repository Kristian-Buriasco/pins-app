{
  "schemaVersion": 2,
  "dockerfileLines": [
    "FROM node:20-alpine AS deps",
    "WORKDIR /app",
    "# Declare build-time args for all required env vars",
    "ARG MONGODB_URI",
    "ARG GOOGLE_CLIENT_ID",
    "ARG GOOGLE_CLIENT_SECRET",
    "ARG NEXTAUTH_SECRET",
    "ARG NEXTAUTH_URL",
    "ENV MONGODB_URI=$MONGODB_URI",
    "ENV GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID",
    "ENV GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET",
    "ENV NEXTAUTH_SECRET=$NEXTAUTH_SECRET",
    "ENV NEXTAUTH_URL=$NEXTAUTH_URL",
    "COPY package.json yarn.lock* package-lock.json* pnpm-lock.yaml* ./",
    "RUN if [ -f yarn.lock ]; then yarn install --frozen-lockfile; \\\n      elif [ -f package-lock.json ]; then npm ci; \\\n      elif [ -f pnpm-lock.yaml ]; then yarn global add pnpm && pnpm i; \\\n      else echo 'No lockfile found.' && exit 1; fi",
    "\nFROM node:20-alpine AS builder",
    "WORKDIR /app",
    "# Pass build-time envs to builder stage as well",
    "ARG MONGODB_URI",
    "ARG GOOGLE_CLIENT_ID",
    "ARG GOOGLE_CLIENT_SECRET",
    "ARG NEXTAUTH_SECRET",
    "ARG NEXTAUTH_URL",
    "ENV MONGODB_URI=$MONGODB_URI",
    "ENV GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID",
    "ENV GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET",
    "ENV NEXTAUTH_SECRET=$NEXTAUTH_SECRET",
    "ENV NEXTAUTH_URL=$NEXTAUTH_URL",
    "COPY . .",
    "COPY --from=deps /app/node_modules ./node_modules",
    "# Move app directory if it exists in src/ to root (for Next.js build)",
    "RUN if [ -d ./src/app ]; then mv ./src/app ./app; fi",
    "RUN if [ -d ./src/pages ]; then mv ./src/pages ./pages; fi",
    "RUN yarn build",
    "\nFROM node:20-alpine AS runner",
    "WORKDIR /app",
    "ENV NODE_ENV=production",
    "# Pass envs to runtime as well",
    "ARG MONGODB_URI",
    "ARG GOOGLE_CLIENT_ID",
    "ARG GOOGLE_CLIENT_SECRET",
    "ARG NEXTAUTH_SECRET",
    "ARG NEXTAUTH_URL",
    "ENV MONGODB_URI=$MONGODB_URI",
    "ENV GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID",
    "ENV GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET",
    "ENV NEXTAUTH_SECRET=$NEXTAUTH_SECRET",
    "ENV NEXTAUTH_URL=$NEXTAUTH_URL",
    "COPY --from=builder /app/public ./public",
    "COPY --from=builder /app/.next ./.next",
    "COPY --from=builder /app/node_modules ./node_modules",
    "COPY --from=builder /app/package.json ./package.json",
    "EXPOSE 3000",
    "CMD [\"yarn\", \"start\"]"
  ]
}
